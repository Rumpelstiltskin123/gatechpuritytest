<script>
  // At the beginning of your script
  console.log("Firebase initializing...");
  
  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyAuulXEMzgGC-r6jegSwQKN_W5FJjd7lfo",
    authDomain: "gatech-purity-test-7d187.firebaseapp.com",
    projectId: "gatech-purity-test-7d187",
    storageBucket: "gatech-purity-test-7d187.firebasestorage.app",
    messagingSenderId: "255210203843",
    appId: "1:255210203843:web:8d72e897798da12ce09076",
    measurementId: "G-B8PLMD1VTR"
  };
  
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  console.log("Firebase initialized successfully");
  
  // Get Firestore reference
  const db = firebase.firestore();
  
  // Read the score and checked items parameter from the URL
  const urlParams = new URLSearchParams(window.location.search);
  const score = urlParams.get('score') || '100';
  const checkedItems = urlParams.get('checked') || '';
  
  document.getElementById('scoreDisplay').textContent = score;
  
  // Function to go back to the test page
  function goBack() {
    window.location.href = "index.html";
  }
  
  // Save result to Firebase
  function saveResult() {
    console.log("Saving result to Firebase...");
    console.log("Score:", score);
    console.log("Checked items:", checkedItems);
    
    // Create an object with the results
    const resultData = {
      score: score,
      checkedItems: checkedItems,
      timestamp: new Date().toISOString(),
      userAgent: navigator.userAgent,
      referrer: document.referrer
    };
    
    // Save to Firebase Firestore
    db.collection('purityTestResults').add(resultData)
      .then(() => {
        console.log("Result saved to Firebase successfully");
        
        // Update visit counter in Firebase
        const visitCounterRef = db.collection('metrics').doc('visits');
        visitCounterRef.get().then((doc) => {
          if (doc.exists) {
            // Increment existing counter
            visitCounterRef.update({
              count: firebase.firestore.FieldValue.increment(1)
            });
            console.log("Visit counter updated");
          } else {
            // Create new counter
            visitCounterRef.set({
              count: 1
            });
            console.log("Visit counter created");
          }
        }).catch(error => {
          console.error("Error updating visit counter:", error);
        });
      })
      .catch((error) => {
        console.error("Error saving to Firebase:", error);
        saveToLocalStorage(resultData); // Fallback to localStorage
      });
  }
  
  // Fallback function to save to localStorage
  function saveToLocalStorage(resultData) {
    console.log("Falling back to localStorage");
    
    // Get existing results or initialize empty array
    let results = JSON.parse(localStorage.getItem('purityTestResults')) || [];
    
    // Add new result
    results.push(resultData);
    
    // Save back to localStorage
    localStorage.setItem('purityTestResults', JSON.stringify(results));
    
    // Update visit counter
    let visits = parseInt(localStorage.getItem('purityTestVisits') || '0');
    localStorage.setItem('purityTestVisits', (visits + 1).toString());
  }
  
  // Add bee pattern background
  function addBeePattern() {
    document.body.style.backgroundImage = "url('https://e7.pngegg.com/pngimages/484/364/png-clipart-georgia-institute-of-technology-georgia-tech-yellow-jackets-football-georgia-tech-yellow-jackets-men-s-basketball-university-of-georgia-miami-hurricanes-football-jacket-miscellaneous-honey-thumbnail.png')";
    document.body.style.backgroundSize = "50px 50px";
    document.body.style.backgroundRepeat = "space";
    document.body.style.backgroundColor = "#F7EED2";
  }
  
  // Test Firebase connection
  function testFirebaseConnection() {
    console.log("Testing Firestore connection...");
    db.collection("test").doc("test-doc").set({
      test: "Testing connection",
      timestamp: new Date().toISOString()
    })
    .then(() => {
      console.log("Test document successfully written!");
    })
    .catch((error) => {
      console.error("Error writing test document: ", error);
    });
  }
  
  // Initialize on page load
  window.onload = function() {
    console.log("Page loaded, initializing...");
    addBeePattern();
    // Remove or comment out this line since you don't want descriptions
    // setDescription(score);
    
    // Test Firebase connection
    testFirebaseConnection();
    
    // Save the actual result
    saveResult();
  }
</script>
