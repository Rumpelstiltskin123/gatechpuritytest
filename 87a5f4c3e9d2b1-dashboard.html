function loadDashboard() {
  console.log("Loading dashboard data...");
  // Show loading indicator
  document.getElementById('loadingIndicator').style.display = 'block';
  document.getElementById('dashboardContent').style.display = 'none';
  
  // First try to get data from Firestore
  db.collection('purityTestResults')
    .orderBy('timestamp', 'desc')
    .get()
    .then((querySnapshot) => {
      console.log("Query returned:", querySnapshot.size, "documents");
      const results = [];
      querySnapshot.forEach((doc) => {
        const data = doc.data();
        console.log("Document data:", data);
        results.push(data);
      });
      
      // Hide loading indicator and show dashboard
      document.getElementById('loadingIndicator').style.display = 'none';
      document.getElementById('dashboardContent').style.display = 'block';
      
      // First update the dashboard with the results we have
      updateDashboard(results);
      
      // Then try to get the visit counter
      db.collection('metrics').doc('visits')
        .get()
        .then((doc) => {
          console.log("Visit counter document:", doc.exists ? "exists" : "does not exist");
          if (doc.exists) {
            const count = doc.data().count;
            console.log("Visit count from Firestore:", count);
            document.getElementById('totalVisitors').textContent = count;
          } else {
            console.log("No visit counter found, using results length");
            document.getElementById('totalVisitors').textContent = results.length;
          }
        })
        .catch((error) => {
          console.error("Error getting visit counter:", error);
          document.getElementById('totalVisitors').textContent = results.length;
        });
    })
    .catch((error) => {
      console.error("Error fetching data from Firestore:", error);
      // Fallback to localStorage if Firestore fails
      console.log("Falling back to localStorage");
      fallbackToLocalStorage();
    });
}

function fallbackToLocalStorage() {
  console.log("Loading data from localStorage");
  // Get data from localStorage as a fallback
  const results = JSON.parse(localStorage.getItem('purityTestResults')) || [];
  const visits = parseInt(localStorage.getItem('purityTestVisits') || '0');
  
  console.log("LocalStorage data:", results.length, "results,", visits, "visits");
  
  document.getElementById('loadingIndicator').style.display = 'none';
  document.getElementById('dashboardContent').style.display = 'block';
  
  document.getElementById('totalVisitors').textContent = visits || results.length;
  updateDashboard(results);
}

function updateDashboard(results) {
  console.log("Updating dashboard with", results.length, "results");
  
  // Calculate and update average score
  if (results.length > 0) {
    const totalScore = results.reduce((sum, result) => {
      const score = parseInt(result.score);
      return isNaN(score) ? sum : sum + score;
    }, 0);
    const average = (totalScore / results.length).toFixed(1);
    console.log("Average score:", average, "from total:", totalScore);
    document.getElementById('averageScore').textContent = average;
  } else {
    document.getElementById('averageScore').textContent = "N/A";
  }
  
  // Populate recent results table
  const tableBody = document.getElementById('recentResults').getElementsByTagName('tbody')[0];
  tableBody.innerHTML = ''; // Clear existing rows
  
  // Get the 10 most recent results
  const recentResults = results.slice(0, 10);
  console.log("Displaying", recentResults.length, "recent results");
  
  recentResults.forEach(result => {
    const row = tableBody.insertRow();
    
    // Format date
    let formattedDate = "Unknown";
    try {
      const date = new Date(result.timestamp);
      formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
    } catch (e) {
      console.error("Error formatting date:", e);
    }
    
    // Create cells
    const dateCell = row.insertCell(0);
    const scoreCell = row.insertCell(1);
    const itemsCell = row.insertCell(2);
    const userAgentCell = row.insertCell(3);
    
    // Add data to cells
    dateCell.textContent = formattedDate;
    scoreCell.textContent = result.score || "Unknown";
    
    // Calculate checked items
    let checkedItemsCount = 0;
    if (result.checkedItems) {
      try {
        const items = result.checkedItems.split(',').filter(item => item.trim() !== '');
        checkedItemsCount = items.length;
      } catch (e) {
        console.error("Error parsing checked items:", e);
      }
    }
    itemsCell.textContent = checkedItemsCount + " items";
    
    // Extract browser and OS info from user agent
    const userAgent = result.userAgent || "Unknown";
    let browserInfo = "Unknown";
    
    if (userAgent.includes("Firefox")) {
      browserInfo = "Firefox";
    } else if (userAgent.includes("Chrome") && !userAgent.includes("Edg")) {
      browserInfo = "Chrome";
    } else if (userAgent.includes("Safari") && !userAgent.includes("Chrome")) {
      browserInfo = "Safari";
    } else if (userAgent.includes("Edg")) {
      browserInfo = "Edge";
    }
    
    let osInfo = "Unknown";
    if (userAgent.includes("Windows")) {
      osInfo = "Windows";
    } else if (userAgent.includes("Mac")) {
      osInfo = "Mac";
    } else if (userAgent.includes("iPhone") || userAgent.includes("iPad")) {
      osInfo = "iOS";
    } else if (userAgent.includes("Android")) {
      osInfo = "Android";
    } else if (userAgent.includes("Linux")) {
      osInfo = "Linux";
    }
    
    userAgentCell.textContent = `${browserInfo} on ${osInfo}`;
  });
  
  // Create charts
  createScoreChart(results);
  createItemsChart(results);
}

function createScoreChart(results) {
  console.log("Creating score distribution chart");
  // Define score ranges
  const ranges = [
    { min: 0, max: 9, label: '0-9' },
    { min: 10, max: 19, label: '10-19' },
    { min: 20, max: 29, label: '20-29' },
    { min: 30, max: 39, label: '30-39' },
    { min: 40, max: 49, label: '40-49' },
    { min: 50, max: 59, label: '50-59' },
    { min: 60, max: 69, label: '60-69' },
    { min: 70, max: 79, label: '70-79' },
    { min: 80, max: 89, label: '80-89' },
    { min: 90, max: 100, label: '90-100' }
  ];
  
  // Count scores in each range
  const counts = ranges.map(range => {
    return results.filter(result => {
      const score = parseInt(result.score);
      return !isNaN(score) && score >= range.min && score <= range.max;
    }).length;
  });
  
  console.log("Score distribution:", counts);
  
  // Create chart
  const ctx = document.getElementById('scoreChart').getContext('2d');
  
  // Destroy existing chart if it exists
  if (window.scoreChart) {
    window.scoreChart.destroy();
  }
  
  window.scoreChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ranges.map(range => range.label),
      datasets: [{
        label: 'Number of Scores',
        data: counts,
        backgroundColor: 'rgba(139, 0, 0, 0.7)',
        borderColor: 'rgba(139, 0, 0, 1)',
        borderWidth: 1
      }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Number of Users'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Score Range'
          }
        }
      },
      plugins: {
        title: {
          display: true,
          text: 'Distribution of Purity Scores'
        }
      }
    }
  });
}

function createItemsChart(results) {
  console.log("Creating most checked items chart");
  // Count frequency of each item
  const itemCounts = {};
  let totalProcessed = 0;
  
  results.forEach(result => {
    if (result.checkedItems) {
      try {
        const items = result.checkedItems.split(',');
        items.forEach(item => {
          if (item && item.trim() !== '') {
            const itemNum = parseInt(item.trim());
            if (!isNaN(itemNum)) {
              itemCounts[itemNum] = (itemCounts[itemNum] || 0) + 1;
              totalProcessed++;
            }
          }
        });
      } catch (e) {
        console.error("Error processing checked items:", e);
      }
    }
  });
  
  console.log("Processed", totalProcessed, "checked items");
  console.log("Item counts:", itemCounts);
  
  // Convert to array and sort by frequency
  const sortedItems = Object.entries(itemCounts)
    .map(([item, count]) => ({ item: `Q${item}`, count }))
    .sort((a, b) => b.count - a.count)
    .slice(0, 10); // Top 10 items
  
  console.log("Top items:", sortedItems);
  
  // Check if we have any items to display
  if (sortedItems.length === 0) {
    document.getElementById('itemsChart').parentNode.innerHTML = 
      '<h2>Most Checked Items</h2><p>No data available yet</p>';
    return;
  }
  
  // Create chart
  const ctx = document.getElementById('itemsChart').getContext('2d');
  
  // Destroy existing chart if it exists
  if (window.itemsChart) {
    window.itemsChart.destroy();
  }
  
  // Create horizontal bar chart with indexAxis='y' for horizontal orientation
  window.itemsChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: sortedItems.map(entry => entry.item),
      datasets: [{
        label: 'Times Checked',
        data: sortedItems.map(entry => entry.count),
        backgroundColor: 'rgba(70, 130, 180, 0.7)',
        borderColor: 'rgba(70, 130, 180, 1)',
        borderWidth: 1
      }]
    },
    options: {
      indexAxis: 'y', // This makes the bars horizontal
      scales: {
        x: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Number of Checks'
          }
        }
      },
      plugins: {
        title: {
          display: true,
          text: 'Most Commonly Checked Items'
        }
      }
    }
  });
}
